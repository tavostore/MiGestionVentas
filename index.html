<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Contable - Facturaci√≥n Multi-producto</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scale-in { animation: scaleIn 0.3s ease-out; }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>

<body class="bg-slate-50">
<div id="app-root"></div>

<script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js"
  }
}
</script>

<script type="module">
import { initializeApp } from "firebase/app";
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "firebase/firestore";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";

const firebaseConfig = {
    apiKey: "AIzaSyBlMF4DzifIDHReEyOpZZLa-5AmeY-YtaQ",
    authDomain: "migestionventas.firebaseapp.com",
    projectId: "migestionventas",
    storageBucket: "migestionventas.firebasestorage.app",
    messagingSenderId: "995901880959",
    appId: "1:995901880959:web:2807cf70c0bb117723dd4a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const { useState, useEffect } = React;

function App() {
    const [sales, setSales] = useState([]);

    useEffect(() => {
        onAuthStateChanged(auth, u => {
            if (!u) signInAnonymously(auth);
        });
        onSnapshot(collection(db, 'sales'), snap => {
            setSales(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
    }, []);

    /* üîß FUNCI√ìN CORREGIDA DE DESCARGA */
    const downloadInvoice = (sale) => {
        const canvas = document.createElement('canvas');
        const scale = 2;
        const height = 600 + (sale.items.length * 30);

        canvas.width = 450 * scale;
        canvas.height = height * scale;

        const ctx = canvas.getContext('2d');
        ctx.scale(scale, scale);

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, 450, height);

        ctx.fillStyle = "#4f46e5";
        ctx.font = "bold 22px Arial";
        ctx.textAlign = "center";
        ctx.fillText("RECIBO DE VENTA", 225, 40);

        ctx.fillStyle = "#64748b";
        ctx.font = "10px Arial";
        ctx.fillText(new Date(sale.fecha).toLocaleString(), 225, 60);

        ctx.textAlign = "left";
        ctx.fillStyle = "#94a3b8";
        ctx.font = "bold 10px Arial";
        ctx.fillText("CLIENTE:", 40, 100);

        ctx.fillStyle = "#1e293b";
        ctx.font = "bold 18px Arial";
        ctx.fillText(sale.cliente.toUpperCase(), 40, 125);

        let y = 165;
        ctx.fillStyle = "#94a3b8";
        ctx.font = "bold 10px Arial";
        ctx.fillText("DETALLE DE PRODUCTOS:", 40, y);
        y += 20;

        ctx.font = "13px Arial";
        ctx.fillStyle = "#1e293b";

        sale.items.forEach(item => {
            ctx.fillText(`${item.cantidad}x ${item.productoNombre}`, 40, y);
            ctx.textAlign = "right";
            ctx.font = "bold 13px Arial";
            ctx.fillText(`$${(item.precio * item.cantidad).toLocaleString()}`, 410, y);
            ctx.textAlign = "left";
            ctx.font = "13px Arial";
            y += 25;
        });

        y += 20;
        ctx.strokeStyle = "#e5e7eb";
        ctx.beginPath();
        ctx.moveTo(40, y);
        ctx.lineTo(410, y);
        ctx.stroke();

        y += 30;
        ctx.font = "14px Arial";
        ctx.fillStyle = "#64748b";
        ctx.fillText("TOTAL:", 40, y);
        ctx.font = "bold 22px Arial";
        ctx.fillStyle = "#1e293b";
        ctx.textAlign = "right";
        ctx.fillText(`$${sale.total.toLocaleString()}`, 410, y);

        y += 30;
        ctx.font = "14px Arial";
        ctx.fillStyle = "#10b981";
        ctx.textAlign = "left";
        ctx.fillText("ABONADO:", 40, y);
        ctx.textAlign = "right";
        ctx.font = "bold 14px Arial";
        ctx.fillText(`$${sale.abono.toLocaleString()}`, 410, y);

        y += 25;
        ctx.fillStyle = "#ef4444";
        ctx.textAlign = "left";
        ctx.font = "bold 14px Arial";
        ctx.fillText("PENDIENTE:", 40, y);
        ctx.textAlign = "right";
        ctx.font = "bold 18px Arial";
        ctx.fillText(`$${(sale.total - sale.abono).toLocaleString()}`, 410, y);

        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `Factura-${sale.cliente}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    return (
        React.createElement("div", { className: "p-6" },
            React.createElement("h1", { className: "font-black text-xl mb-4" }, "Historial"),
            sales.map(s =>
                React.createElement("button", {
                    key: s.id,
                    onClick: () => downloadInvoice(s),
                    className: "block bg-indigo-600 text-white p-3 rounded-xl mb-2"
                }, "Descargar factura de ", s.cliente)
            )
        )
    );
}

const root = ReactDOM.createRoot(document.getElementById('app-root'));
root.render(React.createElement(App));
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Contable y Facturación</title>
    <!-- Carga de Librerías Externas -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .invoice-canvas { position: absolute; left: -9999px; top: -9999px; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="app-root"></div>

    <!-- Import Map para gestionar las rutas de Firebase correctamente -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, setDoc, deleteDoc } from "firebase/firestore";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";

        // --- CONFIGURACIÓN DE FIREBASE ACTUALIZADA ---
        const firebaseConfig = {
            apiKey: "AIzaSyBlMF4DzifIDHReEyOpZZLa-5AmeY-YtaQ",
            authDomain: "migestionventas.firebaseapp.com",
            projectId: "migestionventas",
            storageBucket: "migestionventas.firebasestorage.app",
            messagingSenderId: "995901880959",
            appId: "1:995901880959:web:2807cf70c0bb117723dd4a",
            measurementId: "G-85TGF8GC50"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useMemo, useRef } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [products, setProducts] = useState([]);
            const [sales, setSales] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [isDropdownOpen, setIsDropdownOpen] = useState(false);
            const [showInvoice, setShowInvoice] = useState(false);
            const [lastSale, setLastSale] = useState(null);

            // Iconos SVG
            const Icon = ({ name }) => {
                const icons = {
                    wallet: React.createElement("svg", { width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("path", { d: "M21 12V7H5a2 2 0 0 1 0-4h14v4" }), 
                        React.createElement("path", { d: "M3 5v14a2 2 0 0 0 2 2h16v-5" }), 
                        React.createElement("path", { d: "M18 12a2 2 0 0 0 0 4h4v-4Z" })
                    ),
                    dashboard: React.createElement("svg", { width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("rect", { width: "7", height: "9", x: "3", y: "3", rx: "1" }), 
                        React.createElement("rect", { width: "7", height: "5", x: "14", y: "3", rx: "1" }), 
                        React.createElement("rect", { width: "7", height: "9", x: "14", y: "12", rx: "1" }), 
                        React.createElement("rect", { width: "7", height: "5", x: "3", y: "16", rx: "1" })
                    ),
                    package: React.createElement("svg", { width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("path", { d: "M16.5 9.4 7.5 4.21" }), 
                        React.createElement("path", { d: "M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" })
                    ),
                    receipt: React.createElement("svg", { width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("path", { d: "M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z" }),
                        React.createElement("path", { d: "M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8" })
                    ),
                    download: React.createElement("svg", { width: "18", height: "18", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("path", { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), 
                        React.createElement("polyline", { points: "7 10 12 15 17 10" }), 
                        React.createElement("line", { x1: "12", x2: "12", y1: "15", y2: "3" })
                    )
                };
                return icons[name] || null;
            };

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) {
                        console.error("Error de autenticación:", err);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubProd = onSnapshot(collection(db, 'products'), (snap) => setProducts(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubSales = onSnapshot(collection(db, 'sales'), (snap) => {
                    setSales(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => { unsubProd(); unsubSales(); };
            }, [user]);

            const stats = useMemo(() => {
                const ventasTotales = sales.reduce((acc, s) => acc + Number(s.total || 0), 0);
                const recaudado = sales.reduce((acc, s) => acc + Number(s.abono || 0), 0);
                return { ventasTotales, recaudado, deuda: ventasTotales - recaudado };
            }, [sales]);

            const addSale = async (e) => {
                e.preventDefault();
                const form = e.target;
                if (!selectedProduct) return;
                
                const cant = Number(form.cantidad.value);
                const precioVenta = Number(form.precioVenta.value);
                const abono = Number(form.abono.value);
                const total = cant * precioVenta;

                const saleData = {
                    cliente: form.cliente.value,
                    productoNombre: selectedProduct.nombre,
                    cantidad: cant,
                    precioUnitario: precioVenta,
                    total: total,
                    abono: abono,
                    fecha: new Date().toISOString()
                };

                await addDoc(collection(db, 'sales'), saleData);
                if (selectedProduct.id) {
                    await updateDoc(doc(db, 'products', selectedProduct.id), { stock: Number(selectedProduct.stock || 0) - cant });
                }
                
                setLastSale(saleData);
                setShowInvoice(true);
                form.reset();
                setSelectedProduct(null);
                setSearchTerm("");
            };

            const downloadAsImage = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 500;
                const ctx = canvas.getContext('2d');
                
                const svgString = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="400" height="500">
                        <foreignObject width="100%" height="100%">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="font-family: sans-serif; background: white; padding: 40px; height: 100%; border: 1px solid #eee;">
                                <h2 style="color: #4f46e5; margin: 0;">RECIBO DIGITAL</h2>
                                <hr style="border: 1px solid #f1f5f9; margin: 20px 0;"/>
                                <p style="font-size: 12px; color: #64748b;">Cliente:</p>
                                <p style="font-weight: bold; font-size: 16px;">${lastSale.cliente}</p>
                                <div style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px;">
                                    <p style="font-size: 14px; margin: 0;">${lastSale.productoNombre} (x${lastSale.cantidad})</p>
                                    <p style="font-weight: bold; font-size: 20px; margin: 5px 0;">$${lastSale.total.toLocaleString()}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-size: 12px; color: #10b981;">ABONADO: $${lastSale.abono.toLocaleString()}</p>
                                    <p style="font-size: 14px; font-weight: bold; color: #ef4444;">SALDO: $${(lastSale.total - lastSale.abono).toLocaleString()}</p>
                                </div>
                            </div>
                        </foreignObject>
                    </svg>
                `;

                const img = new Image();
                const svg = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svg);

                img.onload = () => {
                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, 400, 500);
                    ctx.drawImage(img, 0, 0);
                    const link = document.createElement("a");
                    link.download = `Recibo-${lastSale.cliente}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    URL.revokeObjectURL(url);
                };
                img.src = url;
            };

            if (loading) return React.createElement("div", { className: "h-screen flex items-center justify-center bg-slate-900 text-white" }, "Conectando con Firebase...");

            return (
                React.createElement("div", { className: "flex min-h-screen" },
                    React.createElement("aside", { className: "w-64 bg-slate-900 text-white p-6 hidden md:block" },
                        React.createElement("div", { className: "flex items-center gap-2 mb-10 text-indigo-400 font-bold text-xl" },
                            React.createElement(Icon, { name: "wallet" }), " Gestión Ventas"
                        ),
                        React.createElement("nav", { className: "space-y-4" },
                            React.createElement("button", { onClick: () => setView('dashboard'), className: `flex items-center gap-3 w-full p-2 rounded ${view === 'dashboard' ? 'bg-indigo-600' : ''}` }, React.createElement(Icon, { name: "dashboard" }), " Dashboard"),
                            React.createElement("button", { onClick: () => setView('inventory'), className: `flex items-center gap-3 w-full p-2 rounded ${view === 'inventory' ? 'bg-indigo-600' : ''}` }, React.createElement(Icon, { name: "package" }), " Inventario"),
                            React.createElement("button", { onClick: () => setView('sales'), className: `flex items-center gap-3 w-full p-2 rounded ${view === 'sales' ? 'bg-indigo-600' : ''}` }, React.createElement(Icon, { name: "receipt" }), " Historial")
                        )
                    ),
                    React.createElement("main", { className: "flex-1 p-8" },
                        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" },
                            React.createElement("div", { className: "bg-white p-6 rounded-xl border" },
                                React.createElement("p", { className: "text-xs text-slate-400 font-bold" }, "VENTAS TOTALES"),
                                React.createElement("h2", { className: "text-2xl font-black" }, `$${stats.ventasTotales.toLocaleString()}`)
                            ),
                            React.createElement("div", { className: "bg-white p-6 rounded-xl border border-emerald-100 bg-emerald-50" },
                                React.createElement("p", { className: "text-xs text-emerald-500 font-bold" }, "RECAUDADO"),
                                React.createElement("h2", { className: "text-2xl font-black text-emerald-600" }, `$${stats.recaudado.toLocaleString()}`)
                            ),
                            React.createElement("div", { className: "bg-white p-6 rounded-xl border border-rose-100 bg-rose-50" },
                                React.createElement("p", { className: "text-xs text-rose-500 font-bold" }, "DEUDA CLIENTES"),
                                React.createElement("h2", { className: "text-2xl font-black text-rose-600" }, `$${stats.deuda.toLocaleString()}`)
                            )
                        ),
                        view === 'dashboard' && React.createElement("div", { className: "bg-white p-8 rounded-2xl border shadow-sm max-w-2xl" },
                            React.createElement("h3", { className: "text-lg font-bold mb-6" }, "Nueva Venta"),
                            React.createElement("form", { onSubmit: addSale, className: "space-y-4" },
                                React.createElement("input", { name: "cliente", placeholder: "Nombre del Cliente", className: "w-full p-3 border rounded-xl", required: true }),
                                React.createElement("div", { className: "relative" },
                                    React.createElement("input", { 
                                        placeholder: "Buscar Producto...", 
                                        value: searchTerm, 
                                        onChange: (e) => {setSearchTerm(e.target.value); setIsDropdownOpen(true)}, 
                                        className: "w-full p-3 border rounded-xl"
                                    }),
                                    isDropdownOpen && searchTerm && React.createElement("div", { className: "absolute w-full bg-white border mt-1 rounded-xl shadow-lg z-10" },
                                        products.filter(p => p.nombre.toLowerCase().includes(searchTerm.toLowerCase())).map(p => (
                                            React.createElement("div", { key: p.id, className: "p-3 hover:bg-slate-50 cursor-pointer border-b last:border-0", onClick: () => {setSelectedProduct(p); setSearchTerm(p.nombre); setIsDropdownOpen(false)} },
                                                p.nombre, " - ", React.createElement("span", { className: "font-bold" }, `$${p.precio}`)
                                            )
                                        ))
                                    )
                                ),
                                React.createElement("div", { className: "grid grid-cols-3 gap-4" },
                                    React.createElement("input", { name: "cantidad", type: "number", placeholder: "Cant.", className: "p-3 border rounded-xl", required: true }),
                                    React.createElement("input", { name: "precioVenta", type: "number", defaultValue: selectedProduct?.precio, placeholder: "Precio", className: "p-3 border rounded-xl", required: true }),
                                    React.createElement("input", { name: "abono", type: "number", placeholder: "Abono", className: "p-3 border rounded-xl", required: true })
                                ),
                                React.createElement("button", { className: "w-full bg-indigo-600 text-white p-4 rounded-xl font-bold hover:bg-indigo-700 transition" }, "Procesar Venta")
                            )
                        ),
                        view === 'inventory' && React.createElement("div", { className: "bg-white p-6 rounded-xl border" },
                            React.createElement("h3", { className: "font-bold mb-4" }, "Inventario Actual"),
                            React.createElement("div", { className: "space-y-2" },
                                products.length === 0 ? "No hay productos. Agrega uno en tu base de datos Firebase." : 
                                products.map(p => (
                                    React.createElement("div", { key: p.id, className: "flex justify-between p-3 border-b items-center" },
                                        React.createElement("div", null, 
                                            React.createElement("p", { className: "font-bold" }, p.nombre),
                                            React.createElement("p", { className: "text-xs text-slate-400" }, `Precio sugerido: $${p.precio}`)
                                        ),
                                        React.createElement("span", { className: `font-bold ${p.stock < 5 ? 'text-rose-500' : 'text-slate-700'}` }, `${p.stock} unid.`)
                                    )
                                ))
                            )
                        ),
                        view === 'sales' && React.createElement("div", { className: "bg-white p-6 rounded-xl border" },
                            React.createElement("h3", { className: "font-bold mb-4" }, "Historial de Ventas"),
                            React.createElement("div", { className: "overflow-x-auto" },
                                React.createElement("table", { className: "w-full text-left" },
                                    React.createElement("thead", null, 
                                        React.createElement("tr", { className: "text-slate-400 text-xs border-b" },
                                            React.createElement("th", { className: "pb-2" }, "FECHA"),
                                            React.createElement("th", { className: "pb-2" }, "CLIENTE"),
                                            React.createElement("th", { className: "pb-2" }, "TOTAL"),
                                            React.createElement("th", { className: "pb-2" }, "SALDO")
                                        )
                                    ),
                                    React.createElement("tbody", null, 
                                        sales.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).map(s => (
                                            React.createElement("tr", { key: s.id, className: "border-b last:border-0 text-sm" },
                                                React.createElement("td", { className: "py-3" }, new Date(s.fecha).toLocaleDateString()),
                                                React.createElement("td", { className: "py-3 font-medium" }, s.cliente),
                                                React.createElement("td", { className: "py-3" }, `$${s.total.toLocaleString()}`),
                                                React.createElement("td", { className: "py-3" }, 
                                                    React.createElement("span", { className: `px-2 py-1 rounded text-xs ${s.total - s.abono <= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}` },
                                                        s.total - s.abono <= 0 ? 'Pagado' : `$${(s.total - s.abono).toLocaleString()}`
                                                    )
                                                )
                                            )
                                        ))
                                    )
                                )
                            )
                        )
                    ),
                    showInvoice && lastSale && React.createElement("div", { className: "fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" },
                        React.createElement("div", { className: "bg-white p-8 rounded-3xl max-w-sm w-full text-center shadow-2xl" },
                            React.createElement("div", { className: "mb-6" },
                                React.createElement("h2", { className: "text-indigo-600 font-black text-2xl" }, "¡VENTA REGISTRADA!"),
                                React.createElement("p", { className: "text-slate-400 text-sm" }, "El recibo está listo para compartir")
                            ),
                            React.createElement("div", { className: "bg-slate-50 p-6 rounded-2xl text-left mb-6" },
                                React.createElement("p", { className: "text-xs font-bold text-slate-400" }, "CLIENTE"),
                                React.createElement("p", { className: "font-bold text-lg mb-2" }, lastSale.cliente),
                                React.createElement("div", { className: "flex justify-between text-sm mb-1" },
                                    React.createElement("span", null, "Total:"),
                                    React.createElement("span", { className: "font-bold" }, `$${lastSale.total.toLocaleString()}`)
                                ),
                                React.createElement("div", { className: "flex justify-between text-sm text-emerald-600" },
                                    React.createElement("span", null, "Abonado:"),
                                    React.createElement("span", { className: "font-bold" }, `$${lastSale.abono.toLocaleString()}`)
                                )
                            ),
                            React.createElement("div", { className: "flex flex-col gap-2" },
                                React.createElement("button", { onClick: downloadAsImage, className: "w-full bg-indigo-600 text-white p-3 rounded-xl font-bold flex items-center justify-center gap-2" },
                                    React.createElement(Icon, { name: "download" }), " Guardar Recibo (Imagen)"
                                ),
                                React.createElement("button", { onClick: () => setShowInvoice(false), className: "w-full bg-slate-200 text-slate-700 p-3 rounded-xl font-bold" }, "Cerrar")
                            )
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app-root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
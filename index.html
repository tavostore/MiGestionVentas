<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Contable - Facturación Multi-producto</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.ibb.co/MyKLSdJ3/1000975368.png">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scale-in { animation: scaleIn 0.3s ease-out; }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="app-root"></div>

    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs } from "firebase/firestore";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";

        const firebaseConfig = {
            apiKey: "AIzaSyBlMF4DzifIDHReEyOpZZLa-5AmeY-YtaQ",
            authDomain: "migestionventas.firebaseapp.com",
            projectId: "migestionventas",
            storageBucket: "migestionventas.firebasestorage.app",
            messagingSenderId: "995901880959",
            appId: "1:995901880959:web:2807cf70c0bb117723dd4a",
            measurementId: "G-85TGF8GC50"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useMemo } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [products, setProducts] = useState([]);
            const [sales, setSales] = useState([]);
            
            // Estado de la venta actual (Carrito)
            const [cliente, setCliente] = useState("");
            const [cart, setCart] = useState([]);
            const [abono, setAbono] = useState(0);
            
            // Campos de entrada para un ítem
            const [itemSearch, setItemSearch] = useState("");
            const [itemPrice, setItemPrice] = useState("");
            const [itemQty, setItemQty] = useState(1);
            const [selectedProd, setSelectedProd] = useState(null);
            const [isDropdownOpen, setIsDropdownOpen] = useState(false);

            const [showInvoice, setShowInvoice] = useState(false);
            const [lastSale, setLastSale] = useState(null);
            const [message, setMessage] = useState(null);
            const [filterDate, setFilterDate] = useState('all');

            const Icon = ({ name, className = "" }) => {
                const icons = {
                    wallet: React.createElement("svg", { className, width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("path", { d: "M21 12V7H5a2 2 0 0 1 0-4h14v4" }), React.createElement("path", { d: "M3 5v14a2 2 0 0 0 2 2h16v-5" }), React.createElement("path", { d: "M18 12a2 2 0 0 0 0 4h4v-4Z" })),
                    dashboard: React.createElement("svg", { className, width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("rect", { width: "7", height: "9", x: "3", y: "3", rx: "1" }), React.createElement("rect", { width: "7", height: "5", x: "14", y: "3", rx: "1" }), React.createElement("rect", { width: "7", height: "9", x: "14", y: "12", rx: "1" }), React.createElement("rect", { width: "7", height: "5", x: "3", y: "16", rx: "1" })),
                    package: React.createElement("svg", { className, width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("path", { d: "M16.5 9.4 7.5 4.21" }), React.createElement("path", { d: "M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" })),
                    receipt: React.createElement("svg", { className, width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("path", { d: "M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z" }), React.createElement("path", { d: "M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8" })),
                    trash: React.createElement("svg", { className, width: "18", height: "18", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" },
                        React.createElement("path", { d: "M3 6h18" }), React.createElement("path", { d: "M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" }), React.createElement("path", { d: "M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" })),
                    plus: React.createElement("svg", { className, width: "18", height: "18", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" },
                        React.createElement("line", { x1: "12", x2: "12", y1: "5", y2: "19" }), React.createElement("line", { x1: "5", x2: "19", y1: "12", y2: "12" })),
                    cancel: React.createElement("svg", { className, width: "18", height: "18", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" },
                        React.createElement("circle", { cx: "12", cy: "12", r: "10" }), React.createElement("line", { x1: "4.93", y1: "4.93", x2: "19.07", y2: "19.07" })),
                    users: React.createElement("svg", { className, width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" },
                        React.createElement("path", { d: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "9", cy: "7", r: "4" })),
                    download: React.createElement("svg", { className, width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, 
                        React.createElement("path", { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), React.createElement("polyline", { points: "7 10 12 15 17 10" }), React.createElement("line", { x1: "12", x2: "12", y1: "15", y2: "3" }))
                };
                return icons[name] || null;
            };

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) setUser(u);
                    else signInAnonymously(auth);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubProd = onSnapshot(collection(db, 'products'), (snap) => {
                    setProducts(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const unsubSales = onSnapshot(collection(db, 'sales'), (snap) => {
                    setSales(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => { unsubProd(); unsubSales(); };
            }, [user]);

            useEffect(() => {
                if (selectedProd) setItemPrice(selectedProd.precio);
                else setItemPrice("");
            }, [selectedProd]);

            const activeSales = useMemo(() => sales.filter(s => s.estado !== 'anulada'), [sales]);

            const stats = useMemo(() => {
                const ventasTotales = activeSales.reduce((acc, s) => acc + Number(s.total || 0), 0);
                const recaudado = activeSales.reduce((acc, s) => acc + Number(s.abono || 0), 0);
                return { ventasTotales, recaudado, deuda: ventasTotales - recaudado };
            }, [activeSales]);

            const cartTotal = useMemo(() => cart.reduce((acc, item) => acc + (item.precio * item.cantidad), 0), [cart]);

            const addToCart = () => {
                if (!itemSearch.trim() || !itemPrice || itemQty <= 0) return alert("Completa los datos del producto");
                
                const newItem = {
                    tempId: Date.now(),
                    productoNombre: itemSearch.trim(),
                    productoId: selectedProd ? selectedProd.id : null,
                    precio: Number(itemPrice),
                    cantidad: Number(itemQty),
                    subtotal: Number(itemPrice) * Number(itemQty)
                };
                
                setCart([...cart, newItem]);
                // Reset inputs de item
                setItemSearch("");
                setItemPrice("");
                setItemQty(1);
                setSelectedProd(null);
            };

            const removeFromCart = (tempId) => {
                setCart(cart.filter(item => item.tempId !== tempId));
            };

            const processSale = async () => {
                if (!cliente.trim()) return alert("Ingresa el nombre del cliente");
                if (cart.length === 0) return alert("El carrito está vacío");

                try {
                    // Actualizar stock de cada producto
                    for (const item of cart) {
                        let pId = item.productoId;
                        if (pId) {
                            const pSnap = products.find(p => p.id === pId);
                            if (pSnap) {
                                await updateDoc(doc(db, 'products', pId), { 
                                    stock: Number(pSnap.stock) - Number(item.cantidad)
                                });
                            }
                        } else {
                            // Crear producto nuevo si no existía
                            const newP = await addDoc(collection(db, 'products'), {
                                nombre: item.productoNombre,
                                precio: item.precio,
                                stock: -item.cantidad
                            });
                            pId = newP.id;
                        }
                        item.productoId = pId; // Actualizar con el ID real
                    }

                    const saleData = {
                        cliente: cliente.trim(),
                        items: cart, // Guardamos el array de productos
                        total: cartTotal,
                        abono: Number(abono),
                        fecha: new Date().toISOString(),
                        estado: 'activa'
                    };

                    await addDoc(collection(db, 'sales'), saleData);
                    setLastSale(saleData);
                    setShowInvoice(true);
                    
                    // Limpiar formulario
                    setCart([]);
                    setCliente("");
                    setAbono(0);
                    setMessage({ text: "Factura procesada con éxito", type: "success" });
                    setTimeout(() => setMessage(null), 3000);
                } catch (e) {
                    alert("Error al procesar la venta.");
                }
            };

            const anularVenta = async (sale) => {
                if (!confirm("¿Anular esta factura? Se devolverá el stock de todos los productos.")) return;
                try {
                    await updateDoc(doc(db, 'sales', sale.id), { estado: 'anulada' });
                    // Devolver stock de cada item
                    for (const item of sale.items) {
                        if (item.productoId) {
                            const pSnap = products.find(p => p.id === item.productoId);
                            if (pSnap) {
                                await updateDoc(doc(db, 'products', item.productoId), { 
                                    stock: Number(pSnap.stock) + Number(item.cantidad)
                                });
                            }
                        }
                    }
                    setMessage({ text: "Factura anulada", type: "success" });
                    setTimeout(() => setMessage(null), 3000);
                } catch (e) { alert("Error"); }
            };

const downloadInvoice = (sale) => {
    const canvas = document.createElement('canvas');
    const height = 600 + (sale.items.length * 30);
    canvas.width = 450;
    canvas.height = height;

    const ctx = canvas.getContext('2d');

    // Fondo
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Encabezado
    ctx.fillStyle = "#4f46e5";
    ctx.font = "bold 22px Inter, Arial";
    ctx.textAlign = "center";
    ctx.fillText("RECIBO DE VENTA", canvas.width / 2, 40);

    ctx.fillStyle = "#64748b";
    ctx.font = "10px Arial";
    ctx.fillText(new Date(sale.fecha).toLocaleString(), canvas.width / 2, 60);

    // Cliente
    ctx.textAlign = "left";
    ctx.fillStyle = "#94a3b8";
    ctx.font = "bold 10px Arial";
    ctx.fillText("CLIENTE:", 40, 100);

    ctx.fillStyle = "#1e293b";
    ctx.font = "bold 18px Arial";
    ctx.fillText(sale.cliente.toUpperCase(), 40, 125);

    // Productos
    let y = 165;
    ctx.fillStyle = "#94a3b8";
    ctx.font = "bold 10px Arial";
    ctx.fillText("DETALLE DE PRODUCTOS:", 40, y);
    y += 20;

    ctx.font = "13px Arial";
    ctx.fillStyle = "#1e293b";

    sale.items.forEach(item => {
        ctx.fillText(`${item.cantidad}x ${item.productoNombre}`, 40, y);
        ctx.textAlign = "right";
        ctx.font = "bold 13px Arial";
        ctx.fillText(
            `$${(item.precio * item.cantidad).toLocaleString()}`,
            canvas.width - 40,
            y
        );
        ctx.textAlign = "left";
        ctx.font = "13px Arial";
        y += 25;
    });

    // Totales
    y += 20;
    ctx.strokeStyle = "#e5e7eb";
    ctx.beginPath();
    ctx.moveTo(40, y);
    ctx.lineTo(canvas.width - 40, y);
    ctx.stroke();

    y += 30;
    ctx.font = "14px Arial";
    ctx.fillStyle = "#64748b";
    ctx.fillText("TOTAL:", 40, y);
    ctx.font = "bold 22px Arial";
    ctx.fillStyle = "#1e293b";
    ctx.textAlign = "right";
    ctx.fillText(`$${sale.total.toLocaleString()}`, canvas.width - 40, y);

    y += 30;
    ctx.font = "14px Arial";
    ctx.fillStyle = "#10b981";
    ctx.textAlign = "left";
    ctx.fillText("ABONADO:", 40, y);
    ctx.textAlign = "right";
    ctx.font = "bold 14px Arial";
    ctx.fillText(`$${sale.abono.toLocaleString()}`, canvas.width - 40, y);

    y += 25;
    ctx.fillStyle = "#ef4444";
    ctx.textAlign = "left";
    ctx.font = "bold 14px Arial";
    ctx.fillText("PENDIENTE:", 40, y);
    ctx.textAlign = "right";
    ctx.font = "bold 18px Arial";
    ctx.fillText(
        `$${(sale.total - sale.abono).toLocaleString()}`,
        canvas.width - 40,
        y
    );

    // Descargar
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = `Factura-${sale.cliente}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

            const registrarAbonoDeuda = async (deudor) => {
                const monto = prompt(`Abono para ${deudor.cliente}.\nSaldo: $${deudor.totalDeuda.toLocaleString()}\n¿Monto?`);
                if (!monto || isNaN(monto) || Number(monto) <= 0) return;
                let abonoRestante = Number(monto);
                try {
                    for (const s of activeSales.filter(v => v.cliente === deudor.cliente && (v.total - v.abono) > 0)) {
                        if (abonoRestante <= 0) break;
                        const deudaVenta = s.total - s.abono;
                        const abonoAplicar = Math.min(abonoRestante, deudaVenta);
                        await updateDoc(doc(db, 'sales', s.id), { abono: s.abono + abonoAplicar });
                        abonoRestante -= abonoAplicar;
                    }
                    setMessage({ text: "Abono aplicado", type: "success" });
                    setTimeout(() => setMessage(null), 3000);
                } catch (e) { alert("Error"); }
            };

            const debtList = useMemo(() => {
                const map = new Map();
                activeSales.forEach(s => {
                    const deuda = s.total - s.abono;
                    if (deuda > 0) {
                        const p = map.get(s.cliente) || { cliente: s.cliente, totalDeuda: 0 };
                        p.totalDeuda += deuda;
                        map.set(s.cliente, p);
                    }
                });
                return Array.from(map.values());
            }, [activeSales]);

            if (loading) return React.createElement("div", { className: "h-screen flex items-center justify-center bg-slate-900 text-white font-black" }, "CARGANDO ERP...");

            return (
                React.createElement("div", { className: "flex flex-col md:flex-row min-h-screen bg-slate-50 pb-24 md:pb-0" },
                    // Sidebar Desktop
                    React.createElement("aside", { className: "w-64 bg-slate-900 text-white p-6 hidden md:flex flex-col h-screen sticky top-0" },
                        React.createElement("div", { className: "flex items-center gap-2 mb-10 text-indigo-400 font-black text-xl" },
                            React.createElement(Icon, { name: "wallet" }), " GESTIÓN VENTAS"
                        ),
                        React.createElement("nav", { className: "space-y-2 flex-1" },
                            [['dashboard', 'dashboard', 'Nueva Venta'], ['inventory', 'package', 'Inventario'], ['debts', 'users', 'Deudas'], ['sales', 'receipt', 'Historial']].map(([v, i, l]) => (
                                React.createElement("button", { key: v, onClick: () => setView(v), className: `flex items-center gap-3 w-full p-4 rounded-xl transition font-bold ${view === v ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800'}` }, 
                                    React.createElement(Icon, { name: i }), l
                                )
                            ))
                        )
                    ),

                    // Navbar Mobile
                    React.createElement("nav", { className: "md:hidden fixed bottom-0 left-0 right-0 bg-slate-900 text-white flex justify-around p-4 z-50 border-t border-slate-800" },
                        [['dashboard', 'dashboard', 'Venta'], ['inventory', 'package', 'Stock'], ['debts', 'users', 'Deudas'], ['sales', 'receipt', 'Historial']].map(([v, i, l]) => (
                            React.createElement("button", { key: v, onClick: () => setView(v), className: `flex flex-col items-center gap-1 ${view === v ? 'text-indigo-400' : 'text-slate-500'}` }, 
                                React.createElement(Icon, { name: i }), React.createElement("span", { className: "text-[10px] font-bold" }, l)
                            )
                        ))
                    ),

                    // Content
                    React.createElement("main", { className: "flex-1 p-4 md:p-8" },
                        message && React.createElement("div", { className: `fixed top-5 right-5 p-4 rounded-xl shadow-2xl z-[100] text-white font-bold animate-bounce ${message.type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'}` }, message.text),

                        // Stats
                        React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8" },
                            React.createElement("div", { className: "bg-white p-6 rounded-2xl border shadow-sm" },
                                React.createElement("p", { className: "text-[10px] text-slate-400 font-black uppercase" }, "Ventas"),
                                React.createElement("h2", { className: "text-2xl font-black text-slate-900" }, `$${stats.ventasTotales.toLocaleString()}`)
                            ),
                            React.createElement("div", { className: "bg-emerald-50 p-6 rounded-2xl border border-emerald-100" },
                                React.createElement("p", { className: "text-[10px] text-emerald-500 font-black uppercase" }, "Recaudado"),
                                React.createElement("h2", { className: "text-2xl font-black text-emerald-600" }, `$${stats.recaudado.toLocaleString()}`)
                            ),
                            React.createElement("div", { className: "bg-rose-50 p-6 rounded-2xl border border-rose-100" },
                                React.createElement("p", { className: "text-[10px] text-rose-500 font-black uppercase" }, "Pendiente"),
                                React.createElement("h2", { className: "text-2xl font-black text-rose-600" }, `$${stats.deuda.toLocaleString()}`)
                            )
                        ),

                        // Nueva Factura (Multi-producto)
                        view === 'dashboard' && React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-8" },
                            // Panel de Ingreso
                            React.createElement("div", { className: "bg-white p-6 md:p-8 rounded-3xl border shadow-sm h-fit" },
                                React.createElement("h3", { className: "text-lg font-black mb-6 uppercase flex items-center gap-2" }, 
                                    React.createElement("span", { className: "w-2 h-6 bg-indigo-600 rounded-full" }), "Generar Factura"
                                ),
                                React.createElement("div", { className: "space-y-6" },
                                    React.createElement("div", null,
                                        React.createElement("label", { className: "text-[10px] font-black text-slate-400 uppercase" }, "Nombre del Cliente"),
                                        React.createElement("input", { 
                                            value: cliente, onChange: (e) => setCliente(e.target.value),
                                            placeholder: "Ej: Juan Pérez", 
                                            className: "w-full p-4 border rounded-2xl mt-1 bg-slate-50 font-bold outline-none focus:ring-2 focus:ring-indigo-500" 
                                        })
                                    ),
                                    React.createElement("div", { className: "bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200" },
                                        React.createElement("p", { className: "text-[11px] font-black text-indigo-600 uppercase mb-4" }, "Agregar Producto al Carrito"),
                                        React.createElement("div", { className: "relative mb-4" },
                                            React.createElement("input", { 
                                                value: itemSearch, 
                                                onChange: (e) => {setItemSearch(e.target.value); setIsDropdownOpen(true); setSelectedProd(null);}, 
                                                placeholder: "Buscar producto...", 
                                                className: "w-full p-4 border rounded-xl bg-white outline-none focus:ring-2 focus:ring-indigo-500 font-bold"
                                            }),
                                            isDropdownOpen && itemSearch && React.createElement("div", { className: "absolute w-full bg-white border mt-1 rounded-xl shadow-2xl z-20 max-h-48 overflow-y-auto" },
                                                products.filter(p => p.nombre.toLowerCase().includes(itemSearch.toLowerCase())).map(p => (
                                                    React.createElement("div", { 
                                                        key: p.id, className: "p-4 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex justify-between items-center",
                                                        onClick: () => {setSelectedProd(p); setItemSearch(p.nombre); setIsDropdownOpen(false)} 
                                                    },
                                                        React.createElement("span", { className: "font-bold" }, p.nombre),
                                                        React.createElement("span", { className: "text-indigo-600 font-black text-xs" }, `$${p.precio}`)
                                                    )
                                                ))
                                            )
                                        ),
                                        React.createElement("div", { className: "grid grid-cols-2 gap-4" },
                                            React.createElement("div", null,
                                                React.createElement("label", { className: "text-[10px] font-bold text-slate-400" }, "PRECIO UNIT."),
                                                React.createElement("input", { 
                                                    type: "number", value: itemPrice, onChange: (e) => setItemPrice(e.target.value),
                                                    className: "w-full p-4 border rounded-xl bg-white font-black text-indigo-600" 
                                                })
                                            ),
                                            React.createElement("div", null,
                                                React.createElement("label", { className: "text-[10px] font-bold text-slate-400" }, "CANTIDAD"),
                                                React.createElement("input", { 
                                                    type: "number", value: itemQty, onChange: (e) => setItemQty(e.target.value),
                                                    className: "w-full p-4 border rounded-xl bg-white font-black" 
                                                })
                                            )
                                        ),
                                        React.createElement("button", { 
                                            onClick: addToCart,
                                            className: "w-full mt-4 bg-slate-900 text-white p-4 rounded-xl font-black text-xs uppercase hover:bg-slate-800 transition"
                                        }, "+ Añadir al Carrito")
                                    )
                                )
                            ),
                            // Panel de Carrito/Resumen
                            React.createElement("div", { className: "bg-white p-6 md:p-8 rounded-3xl border shadow-sm flex flex-col" },
                                React.createElement("h3", { className: "text-lg font-black mb-6 uppercase" }, "Resumen de Factura"),
                                React.createElement("div", { className: "flex-1 space-y-3 mb-6 overflow-y-auto max-h-80 pr-2" },
                                    cart.length === 0 ? React.createElement("div", { className: "text-center py-10 text-slate-400 italic" }, "El carrito está vacío") :
                                    cart.map(item => (
                                        React.createElement("div", { key: item.tempId, className: "flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100" },
                                            React.createElement("div", null,
                                                React.createElement("p", { className: "font-black text-slate-800 uppercase text-xs" }, item.productoNombre),
                                                React.createElement("p", { className: "text-[10px] text-slate-500" }, `${item.cantidad} x $${item.precio.toLocaleString()}`)
                                            ),
                                            React.createElement("div", { className: "flex items-center gap-4" },
                                                React.createElement("span", { className: "font-black text-indigo-600" }, `$${item.subtotal.toLocaleString()}`),
                                                React.createElement("button", { onClick: () => removeFromCart(item.tempId), className: "text-rose-400 hover:text-rose-600" }, React.createElement(Icon, { name: "trash" }))
                                            )
                                        )
                                    ))
                                ),
                                React.createElement("div", { className: "border-t pt-6 space-y-4" },
                                    React.createElement("div", { className: "flex justify-between items-center" },
                                        React.createElement("span", { className: "font-bold text-slate-500" }, "Subtotal:"),
                                        React.createElement("span", { className: "text-2xl font-black text-slate-900" }, `$${cartTotal.toLocaleString()}`)
                                    ),
                                    React.createElement("div", null,
                                        React.createElement("label", { className: "text-[10px] font-black text-emerald-600 uppercase" }, "Abono Inicial"),
                                        React.createElement("input", { 
                                            type: "number", value: abono, onChange: (e) => setAbono(e.target.value),
                                            className: "w-full p-4 border rounded-2xl mt-1 bg-emerald-50 text-emerald-700 font-black text-xl outline-none" 
                                        })
                                    ),
                                    React.createElement("button", { 
                                        onClick: processSale,
                                        className: "w-full bg-indigo-600 text-white p-5 rounded-2xl font-black text-sm uppercase tracking-widest hover:bg-indigo-700 shadow-xl disabled:opacity-50",
                                        disabled: cart.length === 0
                                    }, "Procesar Factura Total")
                                )
                            )
                        ),

                        // Inventario
                        view === 'inventory' && React.createElement("div", { className: "bg-white p-6 rounded-3xl border" },
                            React.createElement("h3", { className: "font-black mb-6 uppercase" }, "Control de Existencias"),
                            React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" },
                                products.map(p => (
                                    React.createElement("div", { key: p.id, className: "p-6 border rounded-2xl hover:border-indigo-300 transition group" },
                                        React.createElement("div", { className: "flex justify-between" },
                                            React.createElement("div", null,
                                                React.createElement("p", { className: "font-black text-slate-900 uppercase text-xs" }, p.nombre),
                                                React.createElement("p", { className: "text-xl font-black text-indigo-600 mt-1" }, `$${Number(p.precio).toLocaleString()}`)
                                            ),
                                            React.createElement("div", { className: "flex gap-2 opacity-0 group-hover:opacity-100 transition" },
                                                React.createElement("button", { onClick: () => {
                                                    const extra = prompt("Unidades a agregar:");
                                                    if(extra) updateDoc(doc(db,'products',p.id), {stock: Number(p.stock) + Number(extra)});
                                                }, className: "p-2 bg-indigo-50 text-indigo-600 rounded-lg" }, React.createElement(Icon, { name: "plus" })),
                                                React.createElement("button", { onClick: () => deleteDoc(doc(db,'products',p.id)), className: "p-2 bg-rose-50 text-rose-600 rounded-lg" }, React.createElement(Icon, { name: "trash" }))
                                            )
                                        ),
                                        React.createElement("div", { className: "mt-4 pt-4 border-t flex justify-between items-center" },
                                            React.createElement("span", { className: "text-[10px] font-bold text-slate-400" }, "STOCK ACTUAL"),
                                            React.createElement("span", { className: `font-black text-sm px-4 py-1 rounded-full ${p.stock <= 0 ? 'bg-rose-100 text-rose-600' : 'bg-slate-100 text-slate-700'}` }, p.stock)
                                        )
                                    )
                                ))
                            )
                        ),

                        // Historial
                        view === 'sales' && React.createElement("div", { className: "bg-white p-6 rounded-3xl border overflow-hidden" },
                            React.createElement("div", { className: "flex justify-between items-center mb-6" },
                                React.createElement("h3", { className: "font-black uppercase" }, "Historial de Facturas"),
                                React.createElement("select", { 
                                    value: filterDate, onChange: (e) => setFilterDate(e.target.value),
                                    className: "bg-slate-100 p-2 rounded-xl text-xs font-bold outline-none"
                                },
                                    React.createElement("option", { value: "all" }, "TODO"),
                                    React.createElement("option", { value: "today" }, "HOY"),
                                    React.createElement("option", { value: "week" }, "ESTA SEMANA")
                                )
                            ),
                            React.createElement("div", { className: "overflow-x-auto" },
                                React.createElement("table", { className: "w-full text-left min-w-[600px]" },
                                    React.createElement("thead", null, 
                                        React.createElement("tr", { className: "text-[10px] font-black text-slate-400 uppercase border-b" },
                                            React.createElement("th", { className: "pb-4" }, "Fecha"),
                                            React.createElement("th", { className: "pb-4" }, "Cliente"),
                                            React.createElement("th", { className: "pb-4" }, "Items"),
                                            React.createElement("th", { className: "pb-4" }, "Total"),
                                            React.createElement("th", { className: "pb-4" }, "Estado"),
                                            React.createElement("th", { className: "pb-4 text-center" }, "Acciones")
                                        )
                                    ),
                                    React.createElement("tbody", null, 
                                        sales.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).map(s => (
                                            React.createElement("tr", { key: s.id, className: `border-b last:border-0 hover:bg-slate-50 transition ${s.estado === 'anulada' ? 'opacity-40' : ''}` },
                                                React.createElement("td", { className: "py-4 text-[11px]" }, new Date(s.fecha).toLocaleDateString()),
                                                React.createElement("td", { className: "py-4 font-black uppercase text-xs" }, s.cliente),
                                                React.createElement("td", { className: "py-4 text-[10px] text-slate-500" }, 
                                                    s.items ? `${s.items.length} prod.` : s.productoNombre 
                                                ),
                                                React.createElement("td", { className: "py-4 font-black text-xs" }, `$${s.total.toLocaleString()}`),
                                                React.createElement("td", { className: "py-4" }, 
                                                    React.createElement("span", { className: `px-2 py-1 rounded-full text-[9px] font-black ${s.estado === 'anulada' ? 'bg-rose-100 text-rose-600' : 'bg-emerald-100 text-emerald-600'}` }, 
                                                        s.estado === 'anulada' ? 'ANULADA' : 'ACTIVA'
                                                    )
                                                ),
                                                React.createElement("td", { className: "py-4 text-center flex justify-center gap-2" },
                                                    s.estado !== 'anulada' && React.createElement(React.Fragment, null,
                                                        React.createElement("button", { onClick: () => downloadInvoice(s), className: "p-2 text-indigo-500 hover:bg-indigo-50 rounded-lg" }, React.createElement(Icon, { name: "download" })),
                                                        React.createElement("button", { onClick: () => anularVenta(s), className: "p-2 text-rose-500 hover:bg-rose-50 rounded-lg" }, React.createElement(Icon, { name: "cancel" }))
                                                    )
                                                )
                                            )
                                        ))
                                    )
                                )
                            )
                        ),

                        // Deudas
                        view === 'debts' && React.createElement("div", { className: "bg-white p-6 rounded-3xl border" },
                            React.createElement("h3", { className: "font-black mb-6 uppercase text-rose-600" }, "Cuentas por Cobrar"),
                            debtList.length === 0 ? React.createElement("p", { className: "text-center py-10 text-slate-400 italic" }, "Sin deudas pendientes") :
                            React.createElement("div", { className: "space-y-4" },
                                debtList.map((d, i) => (
                                    React.createElement("div", { key: i, className: "p-6 border rounded-2xl flex flex-col sm:flex-row justify-between items-center gap-4 bg-white hover:shadow-md transition" },
                                        React.createElement("div", { className: "text-center sm:text-left" },
                                            React.createElement("p", { className: "text-[10px] text-slate-400 font-black" }, "DEUDOR"),
                                            React.createElement("p", { className: "text-xl font-black text-slate-900 uppercase" }, d.cliente)
                                        ),
                                        React.createElement("div", { className: "flex flex-col items-center sm:items-end gap-2" },
                                            React.createElement("p", { className: "text-2xl font-black text-rose-600" }, `$${d.totalDeuda.toLocaleString()}`),
                                            React.createElement("button", { onClick: () => registrarAbonoDeuda(d), className: "bg-slate-900 text-white px-6 py-2 rounded-xl text-xs font-black hover:bg-indigo-600 transition" }, "REGISTRAR ABONO")
                                        )
                                    )
                                ))
                            )
                        )
                    ),

                    // Modal Factura Exitosa
                    showInvoice && lastSale && React.createElement("div", { className: "fixed inset-0 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 z-[100]" },
                        React.createElement("div", { className: "bg-white p-8 rounded-[40px] max-w-sm w-full text-center shadow-2xl scale-in" },
                            React.createElement("div", { className: "w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6" },
                                React.createElement("svg", { width: "40", height: "40", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "3" }, React.createElement("polyline", { points: "20 6 9 17 4 12" }))
                            ),
                            React.createElement("h2", { className: "text-slate-900 font-black text-2xl mb-2 uppercase" }, "Factura Lista"),
                            React.createElement("p", { className: "text-slate-400 text-sm mb-6" }, `Se han procesado ${lastSale.items.length} productos para ${lastSale.cliente}`),
                            React.createElement("div", { className: "flex flex-col gap-3" },
                                React.createElement("button", { onClick: () => downloadInvoice(lastSale), className: "w-full bg-indigo-600 text-white p-5 rounded-2xl font-black flex items-center justify-center gap-3 hover:bg-indigo-700 shadow-lg shadow-indigo-200" },
                                    React.createElement(Icon, { name: "download" }), "DESCARGAR FACTURA"
                                ),
                                React.createElement("button", { onClick: () => setShowInvoice(false), className: "w-full text-slate-400 p-2 text-xs font-black uppercase" }, "Finalizar")
                            )
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app-root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>


